<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Farmhouse Booking</title>
 <style>
  * {
    box-sizing: border-box;
  }

 body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: url('bhaktifarm.jpeg') no-repeat center center fixed;
    background-size: cover;
    padding: 30px;
}

  .form-box {
    background: #ffffff;
    padding: 30px;
    max-width: 650px;
    margin: auto;
    border-radius: 14px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
  }

  .brand {
    text-align: center;
    font-size: 32px;
    font-weight: 800;
    color: white;
    text-shadow: 0 2px 6px rgba(0,0,0,0.6);
    margin-bottom: 8px;
    letter-spacing: 1px;
  }

  h2 {
    text-align: center;
    color: #444;
    margin-bottom: 25px;
  }

  h3 {
    color: #2e7d32;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 20px;
  }

  label {
    display: block;
    margin-top: 14px;
    font-weight: 600;
    color: #333;
  }

  input, select, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #4caf50;
  }

  .row {
    display: flex;
    gap: 12px;
    margin-top: 5px;
  }

  .row div {
    flex: 1;
  }

  textarea {
    resize: vertical;
    min-height: 80px;
  }

  .summary {
    background: #f9f9f9;
    padding: 18px;
    margin-top: 25px;
    border-radius: 10px;
    border-left: 5px solid #4caf50;
  }

  .summary div {
    margin-bottom: 6px;
    font-size: 15px;
  }

  .total {
    font-size: 22px;
    font-weight: 800;
    color: #2e7d32;
    margin-top: 10px;
  }

  button {
    margin-top: 25px;
    padding: 14px;
    width: 100%;
    font-size: 18px;
    font-weight: bold;
    background: #4caf50;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button:hover {
    background: #388e3c;
  }

  @media (max-width: 600px) {
    .row {
      flex-direction: column;
    }
  }

  .tariff-table, .datetime-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0 10px;
    font-size: 15px;
    background: #ffffff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .tariff-table th, .datetime-table th {
    background: #2e7d32;
    color: #ffffff;
    padding: 12px;
    text-align: left;
    font-weight: 600;
  }

  .tariff-table td, .datetime-table td {
    padding: 12px;
    border-bottom: 1px solid #e0e0e0;
  }

  .datetime-table td {
    text-align: left;
  }

  .datetime-table input {
    margin-top: 0;
  }

  .tariff-table tbody tr:last-child td,
  .datetime-table tbody tr:last-child td {
    border-bottom: none;
  }

  .tariff-table small {
    font-size: 12px;
    color: #666;
  }

  .weekend-row {
    background: #fff3e0;
  }

  .deposit-note {
    background: #e8f5e9;
    border-left: 5px solid #2e7d32;
    padding: 14px 16px;
    margin: 10px 0 25px;
    border-radius: 8px;
    font-size: 14.5px;
    color: #2e7d32;
    line-height: 1.5;
  }

  .deposit-note span {
    font-weight: bold;
  }

  .checkbox-line {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-weight: 600;
    color: #333;
  }

  .checkbox-line input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .extra-info {
    background: #fff8e1;
    border-left: 5px solid #ffb300;
    padding: 12px 14px;
    margin-top: 15px;
    border-radius: 8px;
    font-size: 14.5px;
    color: #555;
    line-height: 1.5;
  }

  .date-message {
    margin-top: 10px;
    font-size: 14px;
    text-align: center;
    padding: 10px;
    border-radius: 6px;
  }

  .date-message.success {
    color: green;
    background: #e8f5e9;
  }

  .date-message.error {
    color: red;
    background: #ffebee;
  }

  .availability-header {
    background: #1976d2;
    color: white;
    padding: 15px;
    border-radius: 8px 8px 0 0;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-top: 20px;
  }

  .status-available {
    color: #2e7d32;
    font-weight: bold;
  }

  .status-checking {
    color: #ff9800;
    font-weight: bold;
  }

</style>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CR54TKMTNT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CR54TKMTNT');
</script>

</head>

<body>
<div class="brand">Bhakti Farms</div>

<div class="form-box">
  <h2>Farmhouse Booking</h2>

  <label>Name</label>
  <input id="name" required>

  <label>City</label>
  <input id="city" required>

  <label>Phone</label>
  <input id="phone" required>

  <!-- CHECK AVAILABILITY TABLE -->
  <div class="availability-header">üìÖ Check Availability</div>
  <table class="datetime-table">
    <thead>
      <tr>
        <th style="width: 40%;">Field</th>
        <th style="width: 60%;">Enter Details</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Check-in Date</strong></td>
        <td><input type="date" id="checkin" required></td>
      </tr>
      <tr>
        <td><strong>Check-in Time</strong></td>
        <td><input type="time" id="checkinTime" required></td>
      </tr>
      <tr>
        <td><strong>Check-out Date</strong></td>
        <td><input type="date" id="checkout" required></td>
      </tr>
      <tr>
        <td><strong>Check-out Time</strong></td>
        <td><input type="time" id="checkoutTime" required></td>
      </tr>
      <tr>
        <td><strong>Availability Status</strong></td>
        <td id="availabilityStatus" class="status-checking">Select dates to check</td>
      </tr>
    </tbody>
  </table>
  <div id="dateMessage" class="date-message" style="display:none;"></div>
<!-- Duration Display (Auto-calculated) -->
<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 5px solid #2196f3;">
  <strong style="color: #1976d2;">Duration:</strong> 
  <span id="durationDisplay" style="font-size: 18px; font-weight: bold; color: #1976d2;">Not calculated yet</span>
</div>
  

  <div class="row">
    <div>
      <label>Total Persons</label>
      <input type="number" id="persons" required>
    </div>
    <div>
      <label>Adults</label>
      <input type="number" id="adults" required>
    </div>
    <div>
      <label>Children</label>
      <input type="number" id="children" required>
    </div>
  </div>

  <label class="checkbox-line">
    <input type="checkbox" id="projector">
    <span>Projector (‚Çπ1500)</span>
  </label>

  <label class="checkbox-line">
    <input type="checkbox" id="campfire">
    <span>Campfire (‚Çπ500)</span>
  </label>

  <label>Special Requirements</label>
  <textarea id="requirements"></textarea>
  
  <div class="extra-info">
    ‚ûï <strong>Extra guests above 15:</strong> ‚Çπ500 per person<br>
    ‚ûï <strong>Amenities</strong> are charged separately
  </div>

  <h3>Tariff Details</h3>
  <table class="tariff-table">
    <thead>
      <tr>
        <th>Day Type</th>
        <th>12 Hours</th>
        <th>24 Hours</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Weekdays<br><small>(Mon ‚Äì Thu)</small></td>
        <td>‚Çπ10,000</td>
        <td>‚Çπ15,000</td>
      </tr>
      <tr class="weekend-row">
        <td>Weekends<br><small>(Fri ‚Äì Sun)</small></td>
        <td>‚Çπ13,000</td>
        <td>‚Çπ20,000</td>
      </tr>
    </tbody>
  </table>

  <div class="deposit-note">
    <strong>Security Deposit:</strong><br>
    ‚Çπ5,000 <span>(Refundable)</span> will be collected at check-in.<br>
    It will be returned at check-out after a quick inspection to ensure the
    property is handed over in good condition.
  </div>

  <h3>Cost Summary</h3>
  <div class="summary" id="summary">
    <div>Base Price: ‚Çπ0</div>
    <div>Extra Guest Charges: ‚Çπ0</div>
    <div>Amenities Cost: ‚Çπ0</div>
    <div class="total">Total: ‚Çπ0</div>
  </div>

  <button onclick="submitBooking()">Submit Booking</button>
</div>

<script>
let basePrice = 0, extraGuestCharge = 0, amenitiesCost = 0;
let bookedDates = [];
let calculatedDuration = 0;

// Fetch booked dates on page load
window.addEventListener("DOMContentLoaded", () => {
  fetchBookedDates();
  
  // Add listeners to all relevant fields
  ["checkin","checkout","checkinTime","checkoutTime","persons","adults","children","projector","campfire"]
    .forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener("change", calculateDurationAndTotal);
        element.addEventListener("input", calculateDurationAndTotal);
      }
    });
    
  // Add validation for date selection
  document.getElementById("checkin").addEventListener("change", validateDateSelection);
  document.getElementById("checkout").addEventListener("change", validateDateSelection);
  document.getElementById("checkinTime").addEventListener("change", validateDateSelection);
  document.getElementById("checkoutTime").addEventListener("change", validateDateSelection);
  
  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("checkin").setAttribute("min", today);
  document.getElementById("checkout").setAttribute("min", today);
});

function fetchBookedDates() {
  const url = "https://script.google.com/macros/s/AKfycbw3qsbKAetknjN87DFFssLHbblZD_9i4RtM-SoqLueZG5c7g3B0al0wEq-gZnbJKbum/exec?action=getBookedDates";
  
  fetch(url)
    .then(res => res.json())
    .then(dates => {
      bookedDates = dates;
      console.log("Booked dates loaded:", bookedDates);
    })
    .catch(err => {
      console.error("Error fetching booked dates:", err);
    });
}

function validateDateSelection() {
  const checkinVal = document.getElementById("checkin").value;
  const checkoutVal = document.getElementById("checkout").value;
  const messageDiv = document.getElementById("dateMessage");
  const statusDiv = document.getElementById("availabilityStatus");
  
  if (!checkinVal && !checkoutVal) {
    messageDiv.style.display = "none";
    statusDiv.className = "status-checking";
    statusDiv.textContent = "Select dates to check";
    return true;
  }
  
  // Check if check-in date is booked
  if (checkinVal && bookedDates.includes(checkinVal)) {
    messageDiv.style.display = "block";
    messageDiv.className = "date-message error";
    messageDiv.textContent = "‚ùå Check-in date is already booked. Please select another date.";
    statusDiv.className = "status-error";
    statusDiv.textContent = "‚ùå NOT AVAILABLE";
    statusDiv.style.color = "red";
    document.getElementById("checkin").value = "";
    return false;
  }
  
  // Check if check-out date is booked
  if (checkoutVal && bookedDates.includes(checkoutVal)) {
    messageDiv.style.display = "block";
    messageDiv.className = "date-message error";
    messageDiv.textContent = "‚ùå Check-out date is already booked. Please select another date.";
    statusDiv.className = "status-error";
    statusDiv.textContent = "‚ùå NOT AVAILABLE";
    statusDiv.style.color = "red";
    document.getElementById("checkout").value = "";
    return false;
  }
  
  // Check if any date in between is booked
  if (checkinVal && checkoutVal) {
    const start = new Date(checkinVal);
    const end = new Date(checkoutVal);
    
        // Allow same date if times are different (will be validated later)
    if (end < start) {
      messageDiv.style.display = "block";
      messageDiv.className = "date-message error";
      messageDiv.textContent = "‚ùå Check-out date cannot be before check-in date.";
      statusDiv.className = "status-error";
      statusDiv.textContent = "‚ùå INVALID DATES";
      statusDiv.style.color = "red";
      return false;
    }
    
    let current = new Date(start);
    
    while (current <= end) {
      const dateStr = current.toISOString().split('T')[0];
      if (bookedDates.includes(dateStr)) {
        messageDiv.style.display = "block";
        messageDiv.className = "date-message error";
        messageDiv.textContent = "‚ùå Some dates in your selected range are already booked. Please choose different dates.";
        statusDiv.className = "status-error";
        statusDiv.textContent = "‚ùå NOT AVAILABLE";
        statusDiv.style.color = "red";
        return false;
      }
      current.setDate(current.getDate() + 1);
    }
    
    messageDiv.style.display = "block";
    messageDiv.className = "date-message success";
    messageDiv.textContent = "‚úÖ Selected dates are available!";
    statusDiv.className = "status-available";
    statusDiv.textContent = "‚úÖ AVAILABLE";
    statusDiv.style.color = "#2e7d32";
  }
  
  return true;
}

function calculateDurationAndTotal() {
  console.log("calculateDurationAndTotal called");
  
  const checkinVal = document.getElementById("checkin").value;
  const checkoutVal = document.getElementById("checkout").value;
  const checkinTime = document.getElementById("checkinTime").value;
  const checkoutTime = document.getElementById("checkoutTime").value;
  const personsVal = Number(document.getElementById("persons").value) || 0;

  console.log("Values:", {checkinVal, checkoutVal, checkinTime, checkoutTime, personsVal});

  // Calculate duration if all date/time fields are filled
  if (checkinVal && checkoutVal && checkinTime && checkoutTime) {
    const checkinDateTime = new Date(checkinVal + " " + checkinTime);
    const checkoutDateTime = new Date(checkoutVal + " " + checkoutTime);
    
    console.log("DateTime objects:", {checkinDateTime, checkoutDateTime});
    
    if (checkoutDateTime <= checkinDateTime) {
      document.getElementById("durationDisplay").textContent = "Invalid - Check-out time must be after check-in time";
      document.getElementById("durationDisplay").style.color = "red";
      document.getElementById("summary").innerHTML =
        `<div style="color:red">‚ùå Check-out time must be after check-in time</div>`;
      return;
    }
    
    // Calculate duration in hours
    const durationMs = checkoutDateTime - checkinDateTime;
    let durationHours = durationMs / (1000 * 60 * 60);
    calculatedDuration = Math.round(durationHours);
    
    // Minimum 12 hours charge
    if (durationHours < 12) {
      durationHours = 12;
      document.getElementById("durationDisplay").textContent = calculatedDuration + " Hours (Charged as 12 Hours - Minimum)";
    } else if (durationHours > 12 && durationHours <= 24) {
      // If more than 12 hours but less than or equal to 24, charge as 24 hours
      durationHours = 24;
      document.getElementById("durationDisplay").textContent = calculatedDuration + " Hours (Charged as 24 Hours)";
    } else {
      document.getElementById("durationDisplay").textContent = calculatedDuration + " Hours";
    }
    document.getElementById("durationDisplay").style.color = "#1976d2";
    
    console.log("Duration:", {durationMs, durationHours, calculatedDuration});
    
    // NEW PRICING LOGIC
    // Step 1: Divide total hours by 12
    const step1 = durationHours / 12;
    console.log("Step 1 (hours / 12):", step1);
    
    // Step 2: Divide by 2
    const step2 = step1 / 2;
    console.log("Step 2 (step1 / 2):", step2);
    
    // Before decimal = number of 24-hour blocks
    const blocks24hr = Math.floor(step2);
    
    // After decimal = if exists, one 12-hour block
    const hasBlock12hr = (step2 - blocks24hr) > 0;
    
    console.log("Pricing breakdown:", {blocks24hr, hasBlock12hr});
    
    // Calculate base price
    basePrice = 0;
    let pricingDetails = [];
    
    // Track current date/time for weekday/weekend calculation
    let currentDateTime = new Date(checkinDateTime);
    
    // Calculate for each 24-hour block
    for (let i = 0; i < blocks24hr; i++) {
      const day = currentDateTime.getDay(); // 0=Sun, 6=Sat
      const isWeekend = (day === 0 || day === 5 || day === 6);
      const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][day];
      const dateStr = currentDateTime.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
      const timeStr = currentDateTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true});
      
      let blockPrice = 0;
      if (isWeekend) {
        blockPrice = 20000; // 24-hour weekend rate
        basePrice += 20000;
      } else {
        blockPrice = 15000; // 24-hour weekday rate
        basePrice += 15000;
      }
      
      pricingDetails.push({
        type: '24hr',
        block: i + 1,
        day: dayName,
        date: dateStr,
        time: timeStr,
        isWeekend: isWeekend,
        price: blockPrice
      });
      
      console.log(`24hr block ${i+1}: ${dayName} ${dateStr} ${timeStr} (${isWeekend ? 'Weekend' : 'Weekday'}), Price: ${blockPrice}`);
      
      // Move to next 24-hour block
      currentDateTime = new Date(currentDateTime.getTime() + (24 * 60 * 60 * 1000));
    }
    
    // Add 12-hour block if exists
    if (hasBlock12hr) {
      const day = currentDateTime.getDay();
      const isWeekend = (day === 0 || day === 5 || day === 6);
      const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][day];
      const dateStr = currentDateTime.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
      const timeStr = currentDateTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true});
      
      let blockPrice = 0;
      if (isWeekend) {
        blockPrice = 13000; // 12-hour weekend rate
        basePrice += 13000;
      } else {
        blockPrice = 10000; // 12-hour weekday rate
        basePrice += 10000;
      }
      
      pricingDetails.push({
        type: '12hr',
        day: dayName,
        date: dateStr,
        time: timeStr,
        isWeekend: isWeekend,
        price: blockPrice
      });
      
      console.log(`12hr block: ${dayName} ${dateStr} ${timeStr} (${isWeekend ? 'Weekend' : 'Weekday'}), Price: ${blockPrice}`);
    }
    
    console.log("Base price calculated:", basePrice);
    
    // Calculate number of chargeable days for extra guests
    const chargeDays = blocks24hr + (hasBlock12hr ? 1 : 0) || 1; // Minimum 1 day
    
    // Extra guest charges - ‚Çπ500 per extra person PER DAY
    let extraGuests = personsVal > 15 ? (personsVal - 15) : 0;
    extraGuestCharge = extraGuests > 0 ? extraGuests * 500 * chargeDays : 0;
    
    console.log("Extra guest calculation:", {extraGuests, chargeDays, extraGuestCharge});
    
  } else {
    document.getElementById("durationDisplay").textContent = "Not calculated yet";
    document.getElementById("durationDisplay").style.color = "#666";
    console.log("Missing date/time fields");
    return;
  }

  // Amenities
  amenitiesCost =
    (document.getElementById("projector").checked ? 1500 : 0) +
    (document.getElementById("campfire").checked ? 500 : 0);

  const total = basePrice + extraGuestCharge + amenitiesCost;

  console.log("Final totals:", {basePrice, extraGuestCharge, amenitiesCost, total});

  // Calculate days and hours breakdown for display
  const totalHours = calculatedDuration < 12 ? 12 : (calculatedDuration > 12 && calculatedDuration <= 24 ? 24 : calculatedDuration);
  const fullDays = Math.floor(totalHours / 24);
  const remainingHours = totalHours % 24;
  
  // Build stay duration display
  let stayDuration = '';
  if (fullDays > 0 && remainingHours > 0) {
    stayDuration = `${fullDays} Day${fullDays > 1 ? 's' : ''} and ${remainingHours} Hour${remainingHours > 1 ? 's' : ''}`;
  } else if (fullDays > 0) {
    stayDuration = `${fullDays} Day${fullDays > 1 ? 's' : ''}`;
  } else {
    stayDuration = `${remainingHours} Hour${remainingHours > 1 ? 's' : ''}`;
  }
  
  // Recalculate for display
  const totalHoursForCharging = calculatedDuration < 12 ? 12 : (calculatedDuration > 12 && calculatedDuration <= 24 ? 24 : calculatedDuration);
  const step1Display = totalHoursForCharging / 12;
  const step2Display = step1Display / 2;
  const blocks24hrDisplay = Math.floor(step2Display);
  const hasBlock12hrDisplay = (step2Display - blocks24hrDisplay) > 0;
  const chargeDaysDisplay = blocks24hrDisplay + (hasBlock12hrDisplay ? 1 : 0) || 1;
  
  // Build per-day pricing breakdown
  let perDayBreakdown = '';
  let currentDateTime = new Date(document.getElementById("checkin").value + " " + document.getElementById("checkinTime").value);
  
  // Show 24-hour blocks
  for (let i = 0; i < blocks24hrDisplay; i++) {
    const day = currentDateTime.getDay();
    const isWeekend = (day === 0 || day === 5 || day === 6);
    const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][day];
    const dateStr = currentDateTime.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
    const price = isWeekend ? 20000 : 15000;
    
    perDayBreakdown += `
      <div style="display: flex; justify-content: space-between; padding: 8px; background: ${isWeekend ? '#fff3e0' : '#f5f5f5'}; border-radius: 5px; margin-bottom: 5px;">
        <div>
          <strong>${dayName}</strong>, ${dateStr}<br>
          <span style="font-size: 12px; color: #666;">24 Hours ${isWeekend ? '(Weekend)' : '(Weekday)'}</span>
        </div>
        <div style="text-align: right;">
          <strong style="color: #2e7d32;">‚Çπ${price.toLocaleString()}</strong>
        </div>
      </div>
    `;
    
    currentDateTime = new Date(currentDateTime.getTime() + (24 * 60 * 60 * 1000));
  }
  
  // Show 12-hour block if exists
  if (hasBlock12hrDisplay) {
    const day = currentDateTime.getDay();
    const isWeekend = (day === 0 || day === 5 || day === 6);
    const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][day];
    const dateStr = currentDateTime.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
    const price = isWeekend ? 13000 : 10000;
    
    perDayBreakdown += `
      <div style="display: flex; justify-content: space-between; padding: 8px; background: ${isWeekend ? '#fff3e0' : '#f5f5f5'}; border-radius: 5px; margin-bottom: 5px;">
        <div>
          <strong>${dayName}</strong>, ${dateStr}<br>
          <span style="font-size: 12px; color: #666;">12 Hours ${isWeekend ? '(Weekend)' : '(Weekday)'}</span>
        </div>
        <div style="text-align: right;">
          <strong style="color: #2e7d32;">‚Çπ${price.toLocaleString()}</strong>
        </div>
      </div>
    `;
  }
  
  console.log("Summary updated");
  
  // Display enhanced summary
  let extraGuests = personsVal > 15 ? (personsVal - 15) : 0;
  
  document.getElementById("summary").innerHTML = `
    <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
      <div style="font-size: 15px; color: #1565c0;"><strong>üìÖ Stay Duration:</strong></div>
      <div style="font-size: 18px; font-weight: bold; color: #0d47a1; margin-top: 5px;">${stayDuration}</div>
      ${calculatedDuration < 12 ? '<div style="font-size: 12px; color: #f57c00; margin-top: 5px;">‚ö†Ô∏è Minimum 12-hour charge applies</div>' : ''}
      ${calculatedDuration > 12 && calculatedDuration <= 24 ? '<div style="font-size: 12px; color: #f57c00; margin-top: 5px;">‚ö†Ô∏è Charged as 24 hours</div>' : ''}
    </div>
    
    <div style="margin-bottom: 15px;">
      <div style="font-size: 15px; margin-bottom: 10px;"><strong>üí∞ Per Day Pricing:</strong></div>
      ${perDayBreakdown}
    </div>
    
    <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
    
    <div style="font-size: 16px;"><strong>Base Price:</strong> ‚Çπ${basePrice.toLocaleString()}</div>
    
    <div style="font-size: 16px; margin-top: 8px;"><strong>Extra Guest Charges:</strong> ‚Çπ${extraGuestCharge.toLocaleString()} 
      ${personsVal > 15 ? '<span style="font-size: 13px; color: #666;">(' + extraGuests + ' extra guest' + (extraGuests > 1 ? 's' : '') + ' √ó ‚Çπ500 √ó ' + chargeDaysDisplay + ' day' + (chargeDaysDisplay > 1 ? 's' : '') + ')</span>' : ''}
    </div>
    
    <div style="font-size: 16px; margin-top: 8px;"><strong>Amenities Cost:</strong> ‚Çπ${amenitiesCost.toLocaleString()}</div>
    ${document.getElementById("projector").checked ? '<div style="font-size: 13px; color: #666; margin-left: 20px;">‚Ä¢ Projector: ‚Çπ1,500</div>' : ''}
    ${document.getElementById("campfire").checked ? '<div style="font-size: 13px; color: #666; margin-left: 20px;">‚Ä¢ Campfire: ‚Çπ500</div>' : ''}
    
    <hr style="margin: 15px 0; border: none; border-top: 2px solid #2e7d32;">
    
    <div class="total">Total: ‚Çπ${total.toLocaleString()}</div>
  `;
}

function checkDateAvailability(checkinDate, checkoutDate, callback) {
  const url = "https://script.google.com/macros/s/AKfycbw3qsbKAetknjN87DFFssLHbblZD_9i4RtM-SoqLueZG5c7g3B0al0wEq-gZnbJKbum/exec?action=checkDate&checkin=" + checkinDate + "&checkout=" + checkoutDate;
  
  fetch(url)
    .then(res => res.text())
    .then(status => {
      if (status.trim() === "BOOKED") {
        alert("‚ùå Sorry, these dates are already booked. Please choose different dates.");
        callback(false);
      } else {
        callback(true);
      }
    })
    .catch(err => {
      alert("‚ùå Error checking availability. Please try again.");
      callback(false);
    });
}

function submitBooking() {
  // Get all values
  const name = document.getElementById("name").value;
  const city = document.getElementById("city").value;
  const phone = document.getElementById("phone").value;
  const checkinDate = document.getElementById("checkin").value;
  const checkoutDate = document.getElementById("checkout").value;
  const checkinTime = document.getElementById("checkinTime").value;
  const checkoutTime = document.getElementById("checkoutTime").value;
  const persons = document.getElementById("persons").value;
  const adults = document.getElementById("adults").value;
  const children = document.getElementById("children").value;

  // Validate required fields
  if (!name) {
    alert("‚ö† Please enter your name.");
    return;
  }

  if (!city) {
    alert("‚ö† Please enter your city.");
    return;
  }

  if (!phone) {
    alert("‚ö† Please enter your phone number.");
    return;
  }

  if (!checkinDate || !checkoutDate) {
    alert("‚ö† Please select check-in and check-out dates.");
    return;
  }

  if (!checkinTime || !checkoutTime) {
    alert("‚ö† Please select check-in and check-out times.");
    return;
  }

  if (!persons || !adults || !children) {
    alert("‚ö† Please enter guest details (persons, adults, children).");
    return;
  }

  if (calculatedDuration === 0) {
    alert("‚ö† Duration not calculated. Please check your dates and times.");
    return;
  }

  // Calculate total if not already done
  if (basePrice === 0) {
    alert("‚ö† Please wait for the cost calculation to complete.");
    calculateDurationAndTotal();
    setTimeout(() => {
      if (basePrice === 0) {
        alert("‚ö† Unable to calculate price. Please check all fields.");
        return;
      }
    }, 500);
    return;
  }
  
  // Validate dates are not booked
  const statusDiv = document.getElementById("availabilityStatus");
  if (statusDiv.textContent.includes("NOT AVAILABLE") || statusDiv.textContent.includes("INVALID")) {
    alert("‚ö† Please select valid dates that are not already booked.");
    return;
  }

  // Show loading message
  const submitButton = document.querySelector("button");
  const originalText = submitButton.textContent;
  submitButton.textContent = "Submitting...";
  submitButton.disabled = true;

  // Double-check availability before submitting
  checkDateAvailability(checkinDate, checkoutDate, function(canSubmit) {
    if (!canSubmit) {
      submitButton.textContent = originalText;
      submitButton.disabled = false;
      return;
    }

    // Proceed with submission
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://script.google.com/macros/s/AKfycbw3qsbKAetknjN87DFFssLHbblZD_9i4RtM-SoqLueZG5c7g3B0al0wEq-gZnbJKbum/exec";

    const fields = {
      name: name,
      city: city,
      phone: phone,
      checkin: checkinDate + " " + checkinTime,
      checkout: checkoutDate + " " + checkoutTime,
      duration: calculatedDuration,
      persons: persons,
      adults: adults,
      children: children,
      projector: document.getElementById("projector").checked ? "Yes" : "No",
      campfire: document.getElementById("campfire").checked ? "Yes" : "No",
      basePrice: basePrice,
      extraGuestCharge: extraGuestCharge,
      amenitiesCost: amenitiesCost,
      total: basePrice + extraGuestCharge + amenitiesCost,
      requirements: document.getElementById("requirements").value || "None"
    };

    for (let key in fields) {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = key;
      input.value = fields[key];
      form.appendChild(input);
    }

    document.body.appendChild(form);
    form.submit();
  });
}
</script>
</body>
</html>

