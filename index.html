<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Farmhouse Booking</title>
 <style>
  * {
    box-sizing: border-box;
  }

 body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: url('bhaktifarm.jpeg') no-repeat center center fixed;
    background-size: cover;
    padding: 30px;
}

  .form-box {
    background: #ffffff;
    padding: 30px;
    max-width: 650px;
    margin: auto;
    border-radius: 14px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
  }

  .brand {
    text-align: center;
    font-size: 32px;
    font-weight: 800;
    color: white;
    text-shadow: 0 2px 6px rgba(0,0,0,0.6);
    margin-bottom: 8px;
    letter-spacing: 1px;
  }

  h2 {
    text-align: center;
    color: #444;
    margin-bottom: 25px;
  }

  h3 {
    color: #2e7d32;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 20px;
  }

  label {
    display: block;
    margin-top: 14px;
    font-weight: 600;
    color: #333;
  }

  input, select, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #4caf50;
  }

  .row {
    display: flex;
    gap: 12px;
    margin-top: 5px;
  }

  .row div {
    flex: 1;
  }

  textarea {
    resize: vertical;
    min-height: 80px;
  }

  .summary {
    background: #f9f9f9;
    padding: 18px;
    margin-top: 25px;
    border-radius: 10px;
    border-left: 5px solid #4caf50;
  }

  .summary div {
    margin-bottom: 6px;
    font-size: 15px;
  }

  .total {
    font-size: 22px;
    font-weight: 800;
    color: #2e7d32;
    margin-top: 10px;
  }

  button {
    margin-top: 25px;
    padding: 14px;
    width: 100%;
    font-size: 18px;
    font-weight: bold;
    background: #4caf50;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button:hover {
    background: #388e3c;
  }

  @media (max-width: 600px) {
    .row {
      flex-direction: column;
    }
  }

  .tariff-table, .datetime-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0 10px;
    font-size: 15px;
    background: #ffffff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .tariff-table th, .datetime-table th {
    background: #2e7d32;
    color: #ffffff;
    padding: 12px;
    text-align: left;
    font-weight: 600;
  }

  .tariff-table td, .datetime-table td {
    padding: 12px;
    border-bottom: 1px solid #e0e0e0;
  }

  .datetime-table td {
    text-align: left;
  }

  .datetime-table input {
    margin-top: 0;
  }

  .tariff-table tbody tr:last-child td,
  .datetime-table tbody tr:last-child td {
    border-bottom: none;
  }

  .tariff-table small {
    font-size: 12px;
    color: #666;
  }

  .weekend-row {
    background: #fff3e0;
  }

  .deposit-note {
    background: #e8f5e9;
    border-left: 5px solid #2e7d32;
    padding: 14px 16px;
    margin: 10px 0 25px;
    border-radius: 8px;
    font-size: 14.5px;
    color: #2e7d32;
    line-height: 1.5;
  }

  .deposit-note span {
    font-weight: bold;
  }

  .checkbox-line {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-weight: 600;
    color: #333;
  }

  .checkbox-line input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .extra-info {
    background: #fff8e1;
    border-left: 5px solid #ffb300;
    padding: 12px 14px;
    margin-top: 15px;
    border-radius: 8px;
    font-size: 14.5px;
    color: #555;
    line-height: 1.5;
  }

  .date-message {
    margin-top: 10px;
    font-size: 14px;
    text-align: center;
    padding: 10px;
    border-radius: 6px;
  }

  .date-message.success {
    color: green;
    background: #e8f5e9;
  }

  .date-message.error {
    color: red;
    background: #ffebee;
  }

  .availability-header {
    background: #1976d2;
    color: white;
    padding: 15px;
    border-radius: 8px 8px 0 0;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-top: 20px;
  }

  .status-available {
    color: #2e7d32;
    font-weight: bold;
  }

  .status-checking {
    color: #ff9800;
    font-weight: bold;
  }

</style>

</head>

<body>
<div class="brand">Bhakti Farms</div>

<div class="form-box">
  <h2>Farmhouse Booking</h2>

  <label>Name</label>
  <input id="name" required>

  <label>City</label>
  <input id="city" required>

  <label>Phone</label>
  <input id="phone" required>

  <!-- CHECK AVAILABILITY TABLE -->
  <div class="availability-header">üìÖ Check Availability</div>
  <table class="datetime-table">
    <thead>
      <tr>
        <th style="width: 40%;">Field</th>
        <th style="width: 60%;">Enter Details</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Check-in Date</strong></td>
        <td><input type="date" id="checkin" required></td>
      </tr>
      <tr>
        <td><strong>Check-in Time</strong></td>
        <td><input type="time" id="checkinTime" required></td>
      </tr>
      <tr>
        <td><strong>Check-out Date</strong></td>
        <td><input type="date" id="checkout" required></td>
      </tr>
      <tr>
        <td><strong>Check-out Time</strong></td>
        <td><input type="time" id="checkoutTime" required></td>
      </tr>
      <tr>
        <td><strong>Availability Status</strong></td>
        <td id="availabilityStatus" class="status-checking">Select dates to check</td>
      </tr>
    </tbody>
  </table>
  <div id="dateMessage" class="date-message" style="display:none;"></div>

  <label>Duration</label>
  <select id="duration" required>
    <option value="">Select</option>
    <option value="12">12 Hours</option>
    <option value="24">24 Hours</option>
  </select>

  <div class="row">
    <div>
      <label>Total Persons</label>
      <input type="number" id="persons" required>
    </div>
    <div>
      <label>Adults</label>
      <input type="number" id="adults" required>
    </div>
    <div>
      <label>Children</label>
      <input type="number" id="children" required>
    </div>
  </div>

  <label class="checkbox-line">
    <input type="checkbox" id="projector">
    <span>Projector (‚Çπ1500)</span>
  </label>

  <label class="checkbox-line">
    <input type="checkbox" id="campfire">
    <span>Campfire (‚Çπ500)</span>
  </label>

  <label>Special Requirements</label>
  <textarea id="requirements"></textarea>
  
  <div class="extra-info">
    ‚ûï <strong>Extra guests above 15:</strong> ‚Çπ500 per person<br>
    ‚ûï <strong>Amenities</strong> are charged separately
  </div>

  <h3>Tariff Details</h3>
  <table class="tariff-table">
    <thead>
      <tr>
        <th>Day Type</th>
        <th>12 Hours</th>
        <th>24 Hours</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Weekdays<br><small>(Mon ‚Äì Thu)</small></td>
        <td>‚Çπ10,000</td>
        <td>‚Çπ15,000</td>
      </tr>
      <tr class="weekend-row">
        <td>Weekends<br><small>(Fri ‚Äì Sun)</small></td>
        <td>‚Çπ13,000</td>
        <td>‚Çπ20,000</td>
      </tr>
    </tbody>
  </table>

  <div class="deposit-note">
    <strong>Security Deposit:</strong><br>
    ‚Çπ5,000 <span>(Refundable)</span> will be collected at check-in.<br>
    It will be returned at check-out after a quick inspection to ensure the
    property is handed over in good condition.
  </div>

  <h3>Cost Summary</h3>
  <div class="summary" id="summary">
    <div>Base Price: ‚Çπ0</div>
    <div>Extra Guest Charges: ‚Çπ0</div>
    <div>Amenities Cost: ‚Çπ0</div>
    <div class="total">Total: ‚Çπ0</div>
  </div>

  <button onclick="submitBooking()">Submit Booking</button>
</div>

<script>
let basePrice = 0, extraGuestCharge = 0, amenitiesCost = 0;
let bookedDates = [];

// Fetch booked dates on page load
window.addEventListener("DOMContentLoaded", () => {
  fetchBookedDates();
  
  ["checkin","checkout","duration","persons","projector","campfire"]
    .forEach(id => {
      document.getElementById(id).addEventListener("change", calculateTotal);
      document.getElementById(id).addEventListener("input", calculateTotal);
    });
    
  // Add validation for date selection
  document.getElementById("checkin").addEventListener("change", validateDateSelection);
  document.getElementById("checkout").addEventListener("change", validateDateSelection);
  document.getElementById("checkinTime").addEventListener("change", validateDateSelection);
  document.getElementById("checkoutTime").addEventListener("change", validateDateSelection);
  
  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("checkin").setAttribute("min", today);
  document.getElementById("checkout").setAttribute("min", today);
});

function fetchBookedDates() {
  const url = "https://script.google.com/macros/s/AKfycbw9_PkJ_6DNlGtyVALNgk-BWLmCKWWFEKajzG3ll-jtnFG9kW4nskgPSDYpndu89t0j/exec?action=getBookedDates";
  
  fetch(url)
    .then(res => res.json())
    .then(dates => {
      bookedDates = dates;
      console.log("Booked dates loaded:", bookedDates);
    })
    .catch(err => {
      console.error("Error fetching booked dates:", err);
    });
}

function validateDateSelection() {
  const checkinVal = document.getElementById("checkin").value;
  const checkoutVal = document.getElementById("checkout").value;
  const messageDiv = document.getElementById("dateMessage");
  const statusDiv = document.getElementById("availabilityStatus");
  
  if (!checkinVal && !checkoutVal) {
    messageDiv.style.display = "none";
    statusDiv.className = "status-checking";
    statusDiv.textContent = "Select dates to check";
    return true;
  }
  
  // Check if check-in date is booked
  if (checkinVal && bookedDates.includes(checkinVal)) {
    messageDiv.style.display = "block";
    messageDiv.className = "date-message error";
    messageDiv.textContent = "‚ùå Check-in date is already booked. Please select another date.";
    statusDiv.className = "status-error";
    statusDiv.textContent = "‚ùå NOT AVAILABLE";
    statusDiv.style.color = "red";
    document.getElementById("checkin").value = "";
    return false;
  }
  
  // Check if check-out date is booked
  if (checkoutVal && bookedDates.includes(checkoutVal)) {
    messageDiv.style.display = "block";
    messageDiv.className = "date-message error";
    messageDiv.textContent = "‚ùå Check-out date is already booked. Please select another date.";
    statusDiv.className = "status-error";
    statusDiv.textContent = "‚ùå NOT AVAILABLE";
    statusDiv.style.color = "red";
    document.getElementById("checkout").value = "";
    return false;
  }
  
  // Check if any date in between is booked
  if (checkinVal && checkoutVal) {
    const start = new Date(checkinVal);
    const end = new Date(checkoutVal);
    
    if (end <= start) {
      messageDiv.style.display = "block";
      messageDiv.className = "date-message error";
      messageDiv.textContent = "‚ùå Check-out date must be after check-in date.";
      statusDiv.className = "status-error";
      statusDiv.textContent = "‚ùå INVALID DATES";
      statusDiv.style.color = "red";
      return false;
    }
    
    let current = new Date(start);
    
    while (current <= end) {
      const dateStr = current.toISOString().split('T')[0];
      if (bookedDates.includes(dateStr)) {
        messageDiv.style.display = "block";
        messageDiv.className = "date-message error";
        messageDiv.textContent = "‚ùå Some dates in your selected range are already booked. Please choose different dates.";
        statusDiv.className = "status-error";
        statusDiv.textContent = "‚ùå NOT AVAILABLE";
        statusDiv.style.color = "red";
        return false;
      }
      current.setDate(current.getDate() + 1);
    }
    
    messageDiv.style.display = "block";
    messageDiv.className = "date-message success";
    messageDiv.textContent = "‚úÖ Selected dates are available!";
    statusDiv.className = "status-available";
    statusDiv.textContent = "‚úÖ AVAILABLE";
    statusDiv.style.color = "#2e7d32";
  }
  
  return true;
}

function calculateTotal() {
  const checkinVal = document.getElementById("checkin").value;
  const checkoutVal = document.getElementById("checkout").value;
  const durationVal = document.getElementById("duration").value;
  const personsVal = Number(document.getElementById("persons").value);

  if (!checkinVal || !checkoutVal || !durationVal || !personsVal) return;

  const checkinDate = new Date(checkinVal);
  const checkoutDate = new Date(checkoutVal);

  if (checkoutDate <= checkinDate) {
    document.getElementById("summary").innerHTML =
      `<div style="color:red">‚ùå Check-out date must be after check-in date</div>`;
    return;
  }

  basePrice = 0;

  // Loop through EACH day
  let currentDate = new Date(checkinDate);

  while (currentDate < checkoutDate) {
    const day = currentDate.getDay(); // 0=Sun, 6=Sat
    const isWeekend = (day === 0 || day === 5 || day === 6);

    let dailyPrice = 0;

    if (isWeekend) {
      dailyPrice = (durationVal == 12) ? 13000 : 20000;
    } else {
      dailyPrice = (durationVal == 12) ? 10000 : 15000;
    }

    basePrice += dailyPrice;

    // Move to next day
    currentDate.setDate(currentDate.getDate() + 1);
  }

  // Extra guest charges
  extraGuestCharge = personsVal > 15 ? (personsVal - 15) * 500 : 0;

  // Amenities
  amenitiesCost =
    (document.getElementById("projector").checked ? 1500 : 0) +
    (document.getElementById("campfire").checked ? 500 : 0);

  const total = basePrice + extraGuestCharge + amenitiesCost;

  document.getElementById("summary").innerHTML = `
    <div>Base Price (Day-wise): ‚Çπ${basePrice}</div>
    <div>Extra Guest Charges: ‚Çπ${extraGuestCharge}</div>
    <div>Amenities Cost: ‚Çπ${amenitiesCost}</div>
    <div class="total">Total: ‚Çπ${total}</div>
  `;
}

function checkDateAvailability(checkinDate, checkoutDate, callback) {
  const url = "https://script.google.com/macros/s/AKfycbw9_PkJ_6DNlGtyVALNgk-BWLmCKWWFEKajzG3ll-jtnFG9kW4nskgPSDYpndu89t0j/exec?action=checkDate&checkin=" + checkinDate + "&checkout=" + checkoutDate;
  
  fetch(url)
    .then(res => res.text())
    .then(status => {
      if (status.trim() === "BOOKED") {
        alert("‚ùå Sorry, these dates are already booked. Please choose different dates.");
        callback(false);
      } else {
        callback(true);
      }
    })
    .catch(err => {
      alert("‚ùå Error checking availability. Please try again.");
      callback(false);
    });
}

function submitBooking() {
  const checkinDate = document.getElementById("checkin").value;
  const checkoutDate = document.getElementById("checkout").value;
  const checkinTime = document.getElementById("checkinTime").value;
  const checkoutTime = document.getElementById("checkoutTime").value;

  if (!checkinDate || !checkoutDate) {
    alert("‚ö† Please select check-in and check-out dates.");
    return;
  }

  if (!checkinTime || !checkoutTime) {
    alert("‚ö† Please select check-in and check-out times.");
    return;
  }
  
  // Validate dates are not booked
  if (!validateDateSelection()) {
    alert("‚ö† Please select valid dates that are not already booked.");
    return;
  }

  // Double-check availability before submitting
  checkDateAvailability(checkinDate, checkoutDate, function(canSubmit) {
    if (!canSubmit) return;

    // Proceed with submission
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://script.google.com/macros/s/AKfycbw9_PkJ_6DNlGtyVALNgk-BWLmCKWWFEKajzG3ll-jtnFG9kW4nskgPSDYpndu89t0j/exec";

    const fields = {
      name: document.getElementById("name").value,
      city: document.getElementById("city").value,
      phone: document.getElementById("phone").value,
      checkin: checkinDate + " " + checkinTime,
      checkout: checkoutDate + " " + checkoutTime,
      duration: document.getElementById("duration").value,
      persons: document.getElementById("persons").value,
      adults: document.getElementById("adults").value,
      children: document.getElementById("children").value,
      projector: document.getElementById("projector").checked ? "Yes" : "No",
      campfire: document.getElementById("campfire").checked ? "Yes" : "No",
      basePrice,
      extraGuestCharge,
      amenitiesCost,
      total: basePrice + extraGuestCharge + amenitiesCost,
      requirements: document.getElementById("requirements").value
    };

    for (let key in fields) {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = key;
      input.value = fields[key];
      form.appendChild(input);
    }

    document.body.appendChild(form);
    form.submit();
  });
}
</script>
</body>
</html>
